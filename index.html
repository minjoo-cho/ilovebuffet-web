<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Guru - 가치투자 분석</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter 폰트 로드 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        .animate-shake:hover {
            animation: shake 0.5s infinite;
        }
        @font-face {
            font-family: 'YoonChildfundkoreaMinGuk';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2408@1.0/YoonChildfundkoreaMinGuk.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://ilovebuffet-web.vercel.app/omaha.png');
            background-size: auto 150vh;
            color: #fff; /* 모든 텍스트를 흰색으로 변경 */
        }
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4); /* 반투명한 검은색 레이어 */
            z-index: -1; /* 내용을 가리지 않도록 z-index 설정 */
        }
        /* 로딩 스피너 애니메이션 */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 모든 텍스트와 요소를 중앙 정렬 */
        .center-content {
            text-align: center;
        }
        #quote-section {
            font-family: 'YoonChildfundkoreaMinGuk';
        }
    </style>
</head>
<body class="text-white bg-black">
    <!-- 전체 페이지 컨테이너 -->
    <div class="container mx-auto p-4 md:p-8">

        <!-- 헤더 섹션 -->
        <header class="center-content mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-2">Ask Guru</h1>
            <div class="mt-4">
                <a href="https://smartstore.naver.com/comeat9/products/12244809201" target="_blank" class="inline-block">
                    <img src="https://ilovebuffet-web.vercel.app/T-shirt.png" alt="I Love Buffet T-Shirt" class="w-10 mx-auto inline-block animate-shake">
                </a>
            </div>
            <p class="text-sm text-gray-300 mt-2">투자 대가의 인사이트를 갈무리하여 쉽게 활용하실 수 있게 도와드립니다.</p>
            <p class="text-sm text-gray-300 mt-2">현재는 버핏의 인사이트만을 지원합니다. 주주서한, 각종 인터뷰에서 언급한 이야기에서 힌트를 얻었습니다.</p>
        </header>

        <main class="space-y-8">
            <!-- 주식 분석기 섹션 (가장 먼저 위치) -->
            <section id="stock-evaluation-section" class="p-6 md:p-8 center-content">
                <h2 class="text-2xl text-white">가치투자 프레임으로 종목을 평가해보세요</h2>
                <p class="text-gray-300 mb-6 text-sm md:text-base">
                    현재 아래의 10개 종목만 지원합니다.
                </p>
                <div class="relative flex items-center justify-center max-w-lg mx-auto">
                    <div id="stock-search-input-container" class="relative flex-grow h-12 border border-white rounded-full focus-within:ring-2 focus-within:ring-white overflow-hidden">
                        <!-- 검색창 내부 버튼과 입력 필드 -->
                        <div id="stock-input-display" class="absolute inset-0 z-10 flex items-center px-3 pointer-events-none">
                            <span id="stock-input-display-text" class="text-white"></span>
                        </div>
                        <input type="text" id="stock-input-field" class="absolute inset-0 w-full p-3 pr-10 bg-transparent text-white z-20 focus:outline-none placeholder-gray-400 opacity-0" placeholder="예: AAPL, 애플">
                        
                        <button id="clear-input-btn" class="absolute inset-y-0 right-4 flex items-center text-white hover:text-gray-300 focus:outline-none z-30 transition-opacity duration-300 opacity-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <button id="analyze-btn" class="w-full sm:w-auto ml-4 px-6 py-3 bg-white text-black rounded-xl font-semibold hover:bg-gray-200 transition-colors">
                        <span id="analyze-btn-text">분석하기</span>
                        <div id="analyze-btn-loader" class="hidden spinner mx-auto"></div>
                    </button>
                </div>
                
                <!-- 수정된 종목 버튼 컨테이너: 두 줄로 분리 -->
                <div class="flex flex-col items-center gap-2 mt-4 mb-6">
                    <div id="ticker-buttons-row1" class="flex flex-wrap gap-2 justify-center">
                        <!-- 첫 번째 줄 버튼 (애플 ~ 테슬라) -->
                    </div>
                    <div id="ticker-buttons-row2" class="flex flex-wrap gap-2 justify-center">
                        <!-- 두 번째 줄 버튼 (엔비디아 ~ 존슨앤드존슨) -->
                    </div>
                </div>

                <div id="error-display" class="hidden mt-4 p-4 text-sm bg-red-800 text-white rounded-xl font-medium center-content"></div>
                <div id="results-display" class="hidden mt-8 center-content">
                    <div class="flex items-center justify-between mb-6">
                        <p class="text-lg font-bold" id="result-stock-name"></p>
                        <p class="text-3xl font-bold" id="result-score-container"><span id="result-score"></span><span class="text-xl text-gray-400">/100</span></p>
                    </div>
                    <div class="p-4 mb-6 bg-gray-900 rounded-lg">
                        <p class="text-sm text-gray-200 font-medium" id="result-message"></p>
                    </div>
                    
                    <h3 class="text-xl font-bold mb-4 text-white">주요 지표 상세</h3>
                    <div id="metrics-table-container">
                        <table class="w-full text-left">
                            <thead class="hidden">
                                <tr>
                                    <th class="p-4 text-xs font-semibold text-gray-200 uppercase tracking-wider">지표</th>
                                    <th class="p-4 text-xs font-semibold text-gray-200 uppercase tracking-wider">값</th>
                                    <th class="p-4 text-center text-xs font-semibold text-gray-200 uppercase tracking-wider">점수</th>
                                    <th class="p-4 text-xs font-semibold text-gray-200 uppercase tracking-wider">설명</th>
                                </tr>
                            </thead>
                            <tbody id="metrics-table-body" class="divide-y divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 시장 지표 섹션 (두 번째 위치) -->
            <section id="market-score-section" class="p-6 md:p-8 center-content">
                <h2 class="text-2xl text-white">가치투자 프레임으로 시장을 읽어보세요</h2>
                <div id="market-main-message-container" class="text-center mb-6 font-bold text-lg">
                    <p id="market-score-message"></p>
                    <p id="market-data-date-display" class="text-sm mt-2"></p>
                </div>
                
                <div id="market-metrics-table-container" class="center-content">
                    <table class="w-full max-w-3xl mx-auto text-left">
                        <thead class="hidden">
                            <tr>
                                <th class="p-4 text-sm font-semibold text-gray-200">지표명</th>
                                <th class="p-4 text-sm font-semibold text-gray-200">계산법</th>
                                <th class="p-4 text-sm font-semibold text-gray-200 text-center">결과</th>
                                <th class="p-4 text-sm font-semibold text-gray-200 text-center">평가</th>
                            </tr>
                        </thead>
                        <tbody id="market-metrics-table-body" class="divide-y divide-gray-700">
                            <!-- 지표 데이터는 JS로 동적 생성 -->
                        </tbody>
                    </table>
                </div>

            </section>

            <!-- 명언 섹션 (세 번째 위치) -->
            <section id="quote-section" class="p-6 md:p-8">
                <div class="max-w-xl mx-auto text-center relative">
                    <p id="quote-text" class="text-xl font-medium text-white transition-opacity duration-500 mb-2">
                        “Risk comes from not knowing what you are doing.”
                    </p>
                    <p id="quote-ko-text" class="text-lg text-gray-300 transition-opacity duration-500 mb-4">
                        “위험은 내가 뭘 하는지 모를 때 생긴다.”
                    </p>
                    <p id="quote-author" class="text-sm text-gray-400 transition-opacity duration-500">
                        - 워렌 버핏
                    </p>
                    <button id="prev-quote-btn" class="absolute top-1/2 left-0 -translate-y-1/2 p-2 rounded-full text-white hover:bg-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <button id="next-quote-btn" class="absolute top-1/2 right-0 -translate-y-1/2 p-2 rounded-full text-white hover:bg-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </section>
        </main>

        <!-- 푸터 섹션 -->
        <footer class="text-center p-6 text-gray-300 text-xs mt-8">
            <p>본 정보는 투자 권유가 아닌 정보 제공 목적으로만 활용됩니다. 투자의 모든 책임은 투자자 본인에게 있습니다.</p>
        </footer>
    </div>

<!-- JavaScript 코드 -->
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    let supabase;
    try {
        const SUPABASE_URL = 'https://nplgsugznwzkssmrkdqg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wbGdzdWd6bnd6a3NzbXJrZHFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxMDYzMTgsImV4cCI6MjA2OTY4MjMxOH0.ePM6z-qg44--rOL4GkXI5GjddYYLjDpBOPf__ngoJdE';
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || !SUPABASE_URL) {
            console.error("Supabase URL is not set.");
            supabase = null;
        } else {
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }
    } catch (e) {
        console.error("Failed to initialize Supabase client.", e);
        supabase = null;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const quoteTextEl = document.getElementById('quote-text');
        const quoteKoTextEl = document.getElementById('quote-ko-text');
        const quoteAuthorEl = document.getElementById('quote-author');
        const stockInputField = document.getElementById('stock-input-field');
        const stockInputDisplay = document.getElementById('stock-input-display');
        const stockInputDisplayText = document.getElementById('stock-input-display-text');
        const analyzeBtn = document.getElementById('analyze-btn');
        const analyzeBtnText = document.getElementById('analyze-btn-text');
        const analyzeBtnLoader = document.getElementById('analyze-btn-loader');
        const errorDisplay = document.getElementById('error-display');
        const resultsDisplay = document.getElementById('results-display');
        const resultStockName = document.getElementById('result-stock-name');
        const resultScore = document.getElementById('result-score');
        const resultMessage = document.getElementById('result-message');
        const metricsTableBody = document.getElementById('metrics-table-body');
        const marketScoreMessageEl = document.getElementById('market-score-message');
        const marketDataDateDisplay = document.getElementById('market-data-date-display');
        const clearInputBtn = document.getElementById('clear-input-btn');
        
        // 종목 버튼 컨테이너를 두 개로 나눔
        const tickerButtonsRow1Container = document.getElementById('ticker-buttons-row1');
        const tickerButtonsRow2Container = document.getElementById('ticker-buttons-row2');

        // 지표 평가 점수 엘리먼트 
        const marketMainMessageEl = document.getElementById('market-main-message-container');
        const marketMetricsTableBody = document.getElementById('market-metrics-table-body');
        const prevQuoteBtn = document.getElementById('prev-quote-btn');
        const nextQuoteBtn = document.getElementById('next-quote-btn');


        // 한글 종목명과 티커를 하나의 객체 배열로 관리
        const stocks = [
            { name: '애플', ticker: 'AAPL' }, 
            { name: '마이크로소프트', ticker: 'MSFT' }, 
            { name: '구글', ticker: 'GOOGL' }, 
            { name: '아마존', ticker: 'AMZN' }, 
            { name: '테슬라', ticker: 'TSLA' },
            { name: '엔비디아', ticker: 'NVDA' }, 
            { name: '비자', ticker: 'V' }, 
            { name: 'JP모건', ticker: 'JPM' }, 
            { name: '유나이티드헬스', ticker: 'UNH' }, 
            { name: '존슨앤드존슨', ticker: 'JNJ' }
        ];

        // 한글명을 티커로 쉽게 찾기 위한 맵 생성
        const tickerMap = stocks.reduce((map, stock) => {
            map[stock.name.toLowerCase()] = stock.ticker;
            return map;
        }, {});
        
        const quotes = [
            { en_quote: "Rule No. 1 is never lose money. Rule No. 2 is never forget Rule No. 1.", ko_quote: "첫째, 절대 돈을 잃지 마라. 둘째, 첫째 규칙을 절대 잊지 마라.", source: "Berkshire Hathaway 주주서한 (1985)" },
            { en_quote: "The stock market is a device for transferring money from the impatient to the patient.", ko_quote: "주식시장은 조급한 사람의 돈이 인내심 있는 사람에게 옮겨가는 곳이다.", source: "Berkshire Hathaway 주주서한 (1989)" },
            { en_quote: "Our favorite holding period is forever.", ko_quote: "우리가 가장 좋아하는 주식 보유 기간은 ‘영원히’다.", source: "Berkshire Hathaway 주주서한 (1988)" },
            { en_quote: "The power of compounding is the eighth wonder of the world.", ko_quote: "복리의 힘은 세상의 여덟 번째 불가사의다.", source: "Columbia Business School 강연 (1999)" },
            { en_quote: "The more you learn, the more you earn.", ko_quote: "배우면 배울수록 돈도 더 벌 수 있다.", source: "Forbes 인터뷰 (2013)" },
            { en_quote: "Risk comes from not knowing what you are doing.", ko_quote: "위험은 내가 뭘 하는지 모를 때 생긴다.", source: "Berkshire Hathaway 주주서한 (1994)" },
            { en_quote: "Be fearful when others are greedy and greedy when others are fearful.", ko_quote: "사람들이 탐욕스러울 때는 조심하고, 두려워할 때는 과감해져라.", source: "Berkshire Hathaway 주주서한 (1986)" },
            { en_quote: "Price is what you pay, value is what you get.", ko_quote: "가격은 내가 치르는 돈이고, 가치는 내가 얻는 것이다.", source: "Berkshire Hathaway 주주서한 (2008)" },
            { en_quote: "Do not save what is left after spending, but spend what is left after saving.", ko_quote: "쓰고 남은 돈을 저축하지 말고, 저축하고 남은 돈을 써라.", source: "인도 비즈니스 스쿨 강연 (2011)" },
            { en_quote: "The three most important words in investing: Margin of safety.", ko_quote: "투자에서 가장 중요한 세 단어는 ‘안전 마진’이다.", source: "Benjamin Graham 언급, 주주서한 (1992)" },
            { en_quote: "It’s far better to buy a wonderful company at a fair price than a fair company at a wonderful price.", ko_quote: "평범한 회사를 싸게 사는 것보다, 훌륭한 회사를 적정가에 사는 게 낫다.", source: "주주서한 (1989)" },
            { en_quote: "Time is the friend of the wonderful business, the enemy of the mediocre.", ko_quote: "시간은 좋은 기업의 편이지만, 평범한 기업에는 독이 된다.", source: "주주서한 (1989)" },
            { en_quote: "Paying too much for a great company is still a bad deal. Paying little for a bad company won't make it a good one.", ko_quote: "좋은 기업이라도 너무 비싸게 사면 나쁜 거래다. 싸게 산다고 좋은 거래가 되는 건 아니다.", source: "CNBC 인터뷰 (2017)" },
            { en_quote: "Only buy something that you'd be perfectly happy to hold if the market shut down for ten years.", ko_quote: "시장이 10년 닫혀도 보유할 만큼 좋은 것만 사라.", source: "Forbes 인터뷰 (1996)" },
            { en_quote: "Diversification is protection against ignorance. It makes little sense if you know what you are doing.", ko_quote: "분산투자는 무지에 대한 방어다. 내가 뭘 아는 사람이라면 필요 없다.", source: "Forbes 인터뷰 (1996)" },
            { en_quote: "Life is like a snowball, all you need is wet snow and a really long hill.", ko_quote: "인생은 눈덩이와 같다. 필요한 건 젖은 눈과 긴 언덕뿐이다.", source: "Fortune 인터뷰 (2012)" },
            { en_quote: "The most important thing to do if you find yourself in a hole is to stop digging.", ko_quote: "구덩이에 빠졌다면, 우선 삽질을 멈추는 게 제일 중요하다.", source: "Omaha World-Herald 인터뷰 (2004)" },
            { en_quote: "Don’t pass up something that’s attractive today because you think you will find something better tomorrow.", ko_quote: "내일 더 좋은 게 있을 거라며 오늘의 좋은 기회를 버리지 마라.", source: "주주서한 (2011)" },
            { en_quote: "There’s never just one cockroach in the kitchen.", ko_quote: "부엌에 바퀴벌레가 한 마리만 있는 법은 없다.", source: "Fortune 인터뷰 (1989)" },
            { en_quote: "When it rains gold, put out the bucket, not the thimble.", ko_quote: "금이 쏟아질 땐 양동이를 들고 나가라.", source: "주주서한 (2016)" },
            { en_quote: "Anything can happen anytime in markets. No one, not even Charlie or I, can predict chaos.", ko_quote: "시장에서는 언제든 무엇이든 일어날 수 있다. 찰리와 나도 혼란이 언제 올지는 모른다.", source: "주주서한 (2014)" },
            { en_quote: "It takes 20 years to build a reputation and five minutes to ruin it.", ko_quote: "명성을 쌓는 데는 20년이 걸리지만, 무너뜨리는 데는 5분이면 충분하다.", source: "주주서한 (1991)" },
            { en_quote: "Lose money for the firm, and I will be understanding. Lose a shred of reputation for the firm, and I will be ruthless.", ko_quote: "회사의 돈을 잃는 건 이해하지만, 회사의 명성을 잃게 하면 무자비하게 대응할 것이다.", source: "주주서한 (1989)" },
            { en_quote: "Know your circle of competence, and stick within it.", ko_quote: "자신의 역량이 미치는 범위를 알고 그 안에 머물러라.", source: "주주서한 (1996)" },
            { en_quote: "You should never test the depth of the water with both feet.", ko_quote: "물 깊이를 양발로 재보아서는 안 된다.", source: "Omaha 인터뷰 (1994)" },
            { en_quote: "Somebody’s sitting in the shade today because someone planted a tree a long time ago.", ko_quote: "오늘 그늘에 앉아 있는 사람은 오래전에 누군가 나무를 심었기 때문이다.", source: "주주서한 (2011)" },
            { en_quote: "Honesty is a very expensive gift. Don’t expect it from cheap people.", ko_quote: "정직은 값비싼 선물이다. 값싼 사람에게서 그것을 기대하지 마라.", source: "Omaha World-Herald 인터뷰 (2008)" },
            { en_quote: "Look for 3 things in a person: intelligence, energy, and integrity. If they lack integrity, the other two don't matter.", ko_quote: "사람을 볼 때는 지능, 열정, 그리고 진실성을 보라. 진실성이 없다면 나머지 두 가지는 아무 소용 없다.", source: "Forbes 인터뷰 (2013)" },
            { en_quote: "It’s better to hang out with people who are better than you.", ko_quote: "나보다 나은 사람들과 어울려라. 그러면 나도 그 방향으로 변하게 된다.", source: "Columbia University 강연 (2009)" },
            { en_quote: "I insist on a lot of time being spent, almost every day, to just sit and think.", ko_quote: "나는 거의 매일, 앉아서 생각하는 데 많은 시간을 써야 한다고 믿는다.", source: "Forbes 인터뷰 (2013)" }
        ];
        
        let currentQuoteIndex = 0;
        let quoteInterval;
        
        function updateQuoteDisplay() {
            if (quotes.length === 0) {
                quoteTextEl.textContent = "명언을 불러올 수 없습니다.";
                quoteKoTextEl.textContent = "";
                quoteAuthorEl.textContent = "";
                return;
            }
            const currentQuote = quotes[currentQuoteIndex];
            quoteTextEl.textContent = `“${currentQuote.en_quote}”`;
            quoteKoTextEl.textContent = `“${currentQuote.ko_quote}”`;
            quoteAuthorEl.textContent = `— ${currentQuote.source}`;
        }
        
        function rotateQuotes() {
            quoteTextEl.style.opacity = 0;
            quoteKoTextEl.style.opacity = 0;
            quoteAuthorEl.style.opacity = 0;
            setTimeout(() => {
                updateQuoteDisplay();
                quoteTextEl.style.opacity = 1;
                quoteKoTextEl.style.opacity = 1;
                quoteAuthorEl.style.opacity = 1;
            }, 500);
        }

        function startQuoteRotation() {
            if (quoteInterval) clearInterval(quoteInterval);
            quoteInterval = setInterval(() => {
                currentQuoteIndex = (currentQuoteIndex + 1) % quotes.length;
                rotateQuotes();
            }, 5000);
        }

        prevQuoteBtn.addEventListener('click', () => {
            currentQuoteIndex = (currentQuoteIndex - 1 + quotes.length) % quotes.length;
            rotateQuotes();
            startQuoteRotation(); // 버튼 클릭 시 타이머 재시작
        });
        
        nextQuoteBtn.addEventListener('click', () => {
            currentQuoteIndex = (currentQuoteIndex + 1) % quotes.length;
            rotateQuotes();
            startQuoteRotation(); // 버튼 클릭 시 타이머 재시작
        });

        updateQuoteDisplay();
        startQuoteRotation();

        // 버튼 생성 함수
        function createTickerButton(stock) {
            const button = document.createElement('button');
            button.className = 'flex items-center border border-white rounded-full px-3 py-1 cursor-pointer transition-colors text-white bg-white/10 hover:bg-white/20';
            button.textContent = `${stock.name} (${stock.ticker})`;
            button.addEventListener('click', () => {
                stockInputField.value = stock.ticker;
                stockInputDisplayText.textContent = stock.name;
                stockInputField.focus();
                updateClearButtonVisibility();
            });
            return button;
        }

        // 종목 버튼 생성 및 이벤트 리스너 추가
        const firstRowStocks = stocks.slice(0, 5);
        const secondRowStocks = stocks.slice(5);

        firstRowStocks.forEach(stock => {
            tickerButtonsRow1Container.appendChild(createTickerButton(stock));
        });

        secondRowStocks.forEach(stock => {
            tickerButtonsRow2Container.appendChild(createTickerButton(stock));
        });

        // 입력 필드 초기화 버튼 기능 
        clearInputBtn.addEventListener('click', () => {
            stockInputField.value = '';
            stockInputDisplayText.textContent = '';
            stockInputField.focus();
            updateClearButtonVisibility();
        });

        // 입력 필드 변경 시 'x' 버튼 가시성 업데이트 및 한글명 자동 변환
        stockInputField.addEventListener('input', () => {
            const inputValue = stockInputField.value.trim();
            const lowerCaseInput = inputValue.toLowerCase();
            const ticker = tickerMap[lowerCaseInput] || inputValue.toUpperCase();
            
            // 한글명을 찾기
            const stockName = stocks.find(s => s.ticker === ticker)?.name || inputValue;

            stockInputDisplayText.textContent = stockName;
            stockInputField.value = ticker; // 입력 필드도 티커로 업데이트
            updateClearButtonVisibility();
        });

        function updateClearButtonVisibility() {
            if (stockInputField.value.length > 0) {
                clearInputBtn.classList.remove('opacity-0');
            } else {
                clearInputBtn.classList.add('opacity-0');
            }
        }
        updateClearButtonVisibility(); // 페이지 로드 시 초기 상태 설정

        async function fetchMarketData() {
            if (!supabase) return;

            try {
                const { data, error } = await supabase
                    .from('market_data')
                    .select('*')
                    .order('data_date', { ascending: false })
                    .limit(1);

                const marketData = data && data.length > 0 ? data[0] : null;

                if (!marketData) {
                    console.error("Supabase market data fetch failed.");
                    marketScoreMessageEl.textContent = "시장 데이터를 불러올 수 없습니다.";
                    return;
                }
                
                // 새로운 종합 평가 로직
                const unfavorableIndicators = [];
                if (marketData.buffett_index >= 100) unfavorableIndicators.push('버핏 지수');
                if (marketData.fed_interest_rate_value > 5) unfavorableIndicators.push('금리 환경');
                if (marketData.us_cpi_value > 5) unfavorableIndicators.push('인플레이션');
                if (marketData.us_gdp_growth_value <= 5) unfavorableIndicators.push('GDP 성장률');

                let marketStatusMessage = '';
                let messageColorClass = '';
                const unfavorableCount = unfavorableIndicators.length;

                if (unfavorableCount >= 3) {
                    marketStatusMessage = '시장 불안';
                    messageColorClass = 'text-red-500';
                } else if (unfavorableCount === 2) {
                    marketStatusMessage = '중간';
                    messageColorClass = 'text-white';
                } else if (unfavorableCount <= 1) {
                    marketStatusMessage = '안정';
                    messageColorClass = 'text-green-500';
                }

                if (marketData.buffett_index >= 200) {
                    marketStatusMessage = '극심한 고평가';
                    messageColorClass = 'text-red-500';
                }

                // 종합 평가 텍스트 업데이트
                marketScoreMessageEl.textContent = marketStatusMessage;
                marketScoreMessageEl.className = `font-bold text-lg ${messageColorClass}`;
                marketDataDateDisplay.textContent = `${marketData.data_date} 기준`;


                // 개별 지표 데이터 
                const metrics = [
                    {
                        name: '버핏 지수',
                        formula: '(미국 상장사 시가총액 ÷ 명목 GDP) × 100',
                        value: `${marketData.buffett_index}%`,
                        evaluation: marketData.buffett_index >= 100 ? '고평가' : '저평가',
                        color: marketData.buffett_index >= 100 ? 'red' : 'green'
                    },
                    {
                        name: '금리 환경',
                        formula: '점수 산정 기준: 5점 초과 시 불리',
                        value: `${marketData.fed_interest_rate_value}점`,
                        evaluation: marketData.fed_interest_rate_value > 5 ? '불리' : '유리',
                        color: marketData.fed_interest_rate_value > 5 ? 'red' : 'green'
                    },
                    {
                        name: '인플레이션',
                        formula: '점수 산정 기준: 5점 초과 시 불안정',
                        value: `${marketData.us_cpi_value}점`,
                        evaluation: marketData.us_cpi_value > 5 ? '불안정' : '안정',
                        color: marketData.us_cpi_value > 5 ? 'red' : 'green'
                    },
                    {
                        name: 'GDP 성장률',
                        formula: '점수 산정 기준: 5점 초과 시 활발',
                        value: `${marketData.us_gdp_growth_value}점`,
                        evaluation: marketData.us_gdp_growth_value > 5 ? '활발' : '둔화',
                        color: marketData.us_gdp_growth_value > 5 ? 'green' : 'red'
                    }
                ];

                // 테이블 동적 생성 
                marketMetricsTableBody.innerHTML = '';
                metrics.forEach(metric => {
                    const row = document.createElement('tr');
                    const colorClass = metric.color === 'red' ? 'text-red-500' : 'text-green-500';
                    row.className = `border-b border-gray-700 last:border-b-0`;
                    row.innerHTML = `
                        <td class="p-4 font-bold text-white">${metric.name}</td>
                        <td class="p-4 text-sm text-gray-400">${metric.formula}</td>
                        <td class="p-4 text-center font-bold">${metric.value}</td>
                        <td class="p-4 text-center font-semibold ${colorClass}">${metric.evaluation}</td>
                    `;
                    marketMetricsTableBody.appendChild(row);
                });


            } catch (e) {
                console.error('Supabase market data fetch failed:', e);
                marketScoreMessageEl.textContent = "시장 데이터를 불러올 수 없습니다.";
            }
        }
        fetchMarketData();

        async function handleAnalysis() {
            if (!supabase) {
                displayError('데이터베이스 연결 실패. Supabase URL과 키를 확인해주세요.');
                return;
            }
            const stockInput = stockInputField.value.trim().toUpperCase();
            if (!stockInput) {
                displayError('종목명이나 티커를 입력해주세요.');
                return;
            }

            // 로딩 상태 시작 
            resultsDisplay.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            analyzeBtnText.classList.add('hidden');
            analyzeBtnLoader.classList.remove('hidden');
            analyzeBtn.disabled = true;

            let stockData = null;
            let queryTicker = stockInput;

            // 한글 종목명을 티커로 변환 
            const lowerCaseInput = stockInput.toLowerCase();
            if (tickerMap[lowerCaseInput]) {
                queryTicker = tickerMap[lowerCaseInput];
            }

            try {
                const { data, error } = await supabase
                    .from('stocks_financials')
                    .select(`*, stock_metrics (*)`)
                    .or(`ticker.eq.${queryTicker}, company_name.ilike.%${queryTicker}%`)
                    .order('report_date', { ascending: false })
                    .limit(1);

                if (data && data.length > 0) {
                    stockData = data[0];
                }
            } catch (e) {
                console.error('Supabase fetch failed:', e);
            } finally {
                // 로딩 상태 종료 
                analyzeBtnText.classList.remove('hidden');
                analyzeBtnLoader.classList.add('hidden');
                analyzeBtn.disabled = false;
            }

            if (stockData) {
                displayResults(stockData);
            } else {
                displayError('해당 종목에 대한 데이터가 없습니다. 지원 종목을 입력해보세요.');
            }
        }

        function displayResults(data) {
            resultStockName.textContent = `${data.company_name} (${data.ticker})`;
            resultScore.textContent = data.total_score;
            resultScore.parentElement.className = `text-3xl font-bold ${data.total_score >= 70 ? 'text-white' : data.total_score >= 50 ? 'text-gray-300' : 'text-red-500'}`;
            resultMessage.textContent = data.total_message;

            metricsTableBody.innerHTML = '';
            
            if (data.stock_metrics && data.stock_metrics.length > 0) {
                data.stock_metrics.forEach(metric => {
                    const scoreColorClass = metric.score > 15 ? 'text-white' : metric.score > 10 ? 'text-gray-300' : 'text-red-500';
                    const tableHtml = `
                        <tr class="bg-gray-900 hover:bg-gray-800 transition-colors">
                            <td class="p-4 text-white">${metric.name}</td>
                            <td class="p-4 text-gray-300">${metric.value}</td>
                            <td class="p-4 text-center font-bold ${scoreColorClass}">${metric.score}</td>
                            <td class="p-4 text-gray-400 text-sm">${metric.message}</td>
                        </tr>
                    `;
                    metricsTableBody.innerHTML += tableHtml;
                });
            }

            resultsDisplay.classList.remove('hidden');
        }
        
        function displayError(message) {
            errorDisplay.textContent = message;
            errorDisplay.classList.remove('hidden');
        }

        analyzeBtn.addEventListener('click', handleAnalysis);
        stockInputField.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleAnalysis();
            }
        });
    });
</script>
</body>
</html>
